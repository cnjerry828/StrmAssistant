name: Build Plugin

on:
  push:
    branches: [tab-ui, simple-ui, lite]
  pull_request:
    branches: [tab-ui, simple-ui, lite]
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup .NET
        uses: actions/setup-dotnet@v3
        with:
          dotnet-version: '6.x'

      - name: Restore dependencies
        run: dotnet restore StrmAssistant.sln

      - name: Build the project
        run: dotnet build StrmAssistant.sln --configuration Release --no-restore

      - name: 查看编译产物（调试用）
        run: dir "${{ github.workspace }}\StrmAssistant\bin\Release\netstandard2.1\"
        shell: pwsh

      - name: 复制产物到输出目录
        run: |
          $pluginName = "StrmAssistant"
          if ("${{ github.ref_name }}" -eq "lite") { $pluginName += "Lite" }
          mkdir -Force "${{ github.workspace }}\output"
          copy "${{ github.workspace }}\StrmAssistant\bin\Release\netstandard2.1\$pluginName.dll" "${{ github.workspace }}\output\"
          # 若有 ChineseConverter.dll，一起复制
          if (Test-Path "${{ github.workspace }}\StrmAssistant\bin\Release\netstandard2.1\ChineseConverter.dll") {
              copy "${{ github.workspace }}\StrmAssistant\bin\Release\netstandard2.1\ChineseConverter.dll" "${{ github.workspace }}\output\"
          }
        shell: pwsh

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: StrmAssistant-${{ github.ref_name }}
          path: ${{ github.workspace }}\output\*
