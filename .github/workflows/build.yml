name: Build Plugin

on:
  push:
    branches: [tab-ui, simple-ui, lite]
  pull_request:
    branches: [tab-ui, simple-ui, lite]
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '3.1.x'

      - name: 下载 Emby 4.9.1.90 核心依赖（关键！）
        run: |
          # 创建依赖目录
          $libDir = "${{ github.workspace }}\libs"
          mkdir -Force $libDir | Out-Null
          
          # 下载 Emby 服务端包（包含 MediaBrowser 系列 DLL）
          Invoke-WebRequest -Uri "https://github.com/MediaBrowser/Emby.Releases/releases/download/4.9.1.90/Emby.Server.Windows-x64.zip" -OutFile "${{ github.workspace }}\emby.zip"
          Expand-Archive -Path "${{ github.workspace }}\emby.zip" -DestinationPath "${{ github.workspace }}\emby" -Force
          
          # 复制 Emby 核心 DLL 到依赖目录
          Copy-Item "${{ github.workspace }}\emby\system\MediaBrowser.*.dll" -Destination $libDir -Force
          Copy-Item "${{ github.workspace }}\emby\system\Newtonsoft.Json.dll" -Destination $libDir -Force # 补充常见依赖
          
          # 将依赖 DLL 引用到项目
          $csprojFile = Get-ChildItem "${{ github.workspace }}" -Recurse -Filter "StrmAssistant.csproj" | Select-Object -First 1
          if ($csprojFile) {
              dotnet add $csprojFile.FullName reference (Get-ChildItem $libDir -Filter "*.dll")
          }
        shell: pwsh

      - name: 还原依赖
        run: dotnet restore "${{ github.workspace }}" --force
        shell: pwsh

      - name: 编译项目
        run: |
          $slnFile = Get-ChildItem "${{ github.workspace }}" -Recurse -Filter "*.sln" | Select-Object -First 1
          if (-not $slnFile) {
              Write-Error "未找到 .sln 文件"
              exit 1
          }
          dotnet build $slnFile.FullName --configuration Release --no-restore
        shell: pwsh

      - name: 复制产物到输出目录
        run: |
          $outputDir = "${{ github.workspace }}\output"
          mkdir -Force $outputDir | Out-Null
          
          $pluginSuffix = if ("${{ github.ref_name }}" -eq "lite") { "Lite" } else { "" }
          $targetDll = Get-ChildItem "${{ github.workspace }}" -Recurse -Filter "StrmAssistant$pluginSuffix.dll" | Where-Object { $_.FullName -match "Release" } | Select-Object -First 1
          if (-not $targetDll) {
              $targetDll = Get-ChildItem "${{ github.workspace }}" -Recurse -Filter "StrmAssistant.dll" | Where-Object { $_.FullName -match "Release" } | Select-Object -First 1
          }
          
          if ($targetDll) {
              Copy-Item $targetDll.FullName -Destination $outputDir -Force
              # 复制 ChineseConverter.dll
              $chineseDll = Get-ChildItem "${{ github.workspace }}" -Recurse -Filter "ChineseConverter.dll" | Where-Object { $_.FullName -match "Release" } | Select-Object -First 1
              if ($chineseDll) { Copy-Item $chineseDll.FullName -Destination $outputDir -Force }
          } else {
              Write-Error "未找到 DLL，但不终止流程（备用方案）"
              # 兜底：复制所有 Release 下的 DLL
              Get-ChildItem "${{ github.workspace }}" -Recurse -Filter "*.dll" | Where-Object { $_.FullName -match "Release" } | Copy-Item -Destination $outputDir -Force
          }
        shell: pwsh

      - name: 上传产物
        uses: actions/upload-artifact@v4
        with:
          name: StrmAssistant-${{ github.ref_name }}
          path: ${{ github.workspace }}\output\*.dll
